#include "vectorized_pcg_rng.hpp"
#include "Ziggurat.hpp"
#include "class_definitions.hpp"
#include <math.h>
#include <immintrin.h>
#include <x86intrin.h>
#ifdef _OPENMP
#include <omp.h>
#endif

// pcg GLOBAL_PCG;
// sZiggurat GLOBAL_ZIGG;
// #pragma omp threadprivate(GLOBAL_PCG)
// #pragma omp threadprivate(GLOBAL_ZIGG)

// int64_t __rdtsc(){
//     unsigned int lo, hi;
//     __asm__ __volatile__ ("rdtsc" : "=a" (lo), "=d" (hi));
//     return ((int64_t)hi << 32) | lo;
// }

#pragma omp parallel private(GLOBAL_PCG)
pcg GLOBAL_PCG = initialize_pcg( __rdtsc());

#ifdef _OPENMP
#pragma omp parallel private(GLOBAL_ZIGG)
sZiggurat GLOBAL_ZIGG = sZiggurat((int)((__rdtsc() << 32 ) >> 32) + 1000 * omp_get_thread_num());
#else
#pragma omp parallel private(GLOBAL_ZIGG)
sZiggurat GLOBAL_ZIGG = sZiggurat((int)((__rdtsc() << 32 ) >> 32));
#endif



__int64_t lcg_multipliers_array [64][16] = {
    {-8012344865979485259, -8171652655953475867, -7712383175063658627, 5588811323601140621, 2371607614505963669, -3957419948967976451, 5462044483291166845, 8478166457409302989, -1049572141432776627, 7392797755656203157, -6630091442671998691, 7532291389097285397, -7519194630909566315, 7976485427217433965, 3607837839429591965, 7003608946646812405},
    {-4547472786080431091, 7712996144543035973, -6877046293671956563, 7099495893070252261, -380436370143396483, -6534211581347848787, 6900458125114630389, 1472234938300608965, -8669347996822925235, 6391505759648972573, 2695697954215045293, 5513512607085789069, 1736088611158527749, -1414187535972191827, 8011034877930307557, 2239350709732857565},
    {90908178860206365, 2436455222744928789, 8939606337505832013, 9223215826764384013, -9120138954827830587, -7418719765837787963, -7183484586854436851, 4975631630612234821, 5971871887283533053, 522086575828845165, -7602203120182760547, 1189241008115444093, 6141482098219114069, 8514615462112188349, -2006838962752798283, 2860738114258780213},
    {-9219789755378143291, 1476541358654984909, 2168195782507171189, 4863414750398508477, -5739944220500201915, -6930091031428681579, 1385720638449825533, 8475873216906312077, 2188882714217485069, 2092799268442580085, 2492283877203485541, 5130434656306940605, -7703835473463762747, 1237402764211965477, 8967320362486448613, 9102109847149985269},
    {-1850632334012109691, 5934137748856246173, 8285189886970491277, 2743614617474601029, -8238053130950378611, -3631355344343902011, -195318101308129787, -3865256629033069651, 6938740953571006741, -2951638516771213683, -2519263430715318867, 8603700650992374821, -771171234535342493, 2561217741910042285, -2463490929323324411, 5353630823558689261},
    {1361764076357426125, 4807195965874180691, 9005237273800730741, -2323309926181647875, 2325742742251274485, -1419365756034459443, -5617225310597729955, -6450884838327943723, -651502224861737099, -8891573380823554067, 902564805725397821, -6108311140225978219, -7916708166050669251, -6230117972063696235, 2975095794271596557, -2256335711121109363},
    {8496078364147444965, 4834592701986404845, 4659566921581733717, -3175189050897049547, 8835057621410111717, 88430943210664029, 2508957561794680709, 1446310259715446317, -2246823611579678883, -1783843459845667691, -6690111123156344683, 6869292406511729005, 532053995396738893, 4511531956364892533, -5629310333345563731, 2655028924071460357},
    {3269378618005779125, -2056420857874051731, 8908502445386225501, 65798833092297733, 5319204827957890869, 5887087518067168229, 3417124946908551533, -2321855942184997907, 8890947306356016379, -5670515941938892299, -1686140348070781563, -8853052076579602611, -112751210502638859, 2904851099710357117, -7963487488449170691, -6590331927168653675},
    {-4833975732351313203, -132712070094978475, -2431004952169984235, -6730470142747417179, -3163824014599461579, -5829734792067997731, -2783811012450880179, -4461901372345708683, -5083722749551332387, 7155224812736754229, 2518538975758646789, -6688845707987719507, 3569831403443679109, -2557188192060683403, 7137029039599426101, -3719908389486441619},
    {-3884838749511774187, -4056400969772069319, -3174236982937013123, -2468746677970415491, -7261754691759291211, -2246559941424997563, -418250326542510379, -5456770111086827771, -5757811642295757443, 6958869634496571605, 1795866247182433533, -6206621272297621899, -890840474188748587, -3317351962755315579, 3390351477458840133, -5051070739138589627},
    {-113401583934231411, 4490950183018055117, 2316092349409029461, -7608350463049904907, -8193547794207030067, -3507394314111099235, 1333409106820460781, -1704102797755079019, 8122910105552326917, -3504804086742487475, 408792021223028301, 7312219510840939117, -6904933789079101235, -5047754665027621523, -7743360029163209963, -7432274087510394547},
    {-1126207081916094579, 8509318914580750029, 7631798192239404781, -6558954047969369371, -2665787777940210243, -558505688693460451, -1066750611965849035, -6937231730420872771, 7370563132221905941, 5943342356832918597, 1365063754178832757, -9139595500510645459, -3014481784250621427, 6365055296019570749, 4903391681555345747, -3826700443076122355},
    {1471265341382059597, 6532287207696200557, 8658259376220566493, 6246328105624210349, -1572744227115845515, 2484538957131184885, -5005874001240553147, 5406912878771988149, -2791606443577360899, 3090980763341572949, -5693460624810558195, 2013993434326858501, -7355240128422327955, -8860887410879038771, 7183078821464656733, -2050437386199573147},
    {1785581307510127701, 6607541618218898733, 4048997508238752995, -4497756384080788971, -3745729859100068147, 7347309646872663869, -6458765140794716579, 1433983948462125781, -2385463370550080363, -3253864803971294299, -5739741695740854923, 8378561564791933829, -5850947046957008659, 2803938183586950405, 2796617957466313045, 4213405826782045293},
    {-5144357427018956867, 705799309620285677, -5398359780689710147, -2833471376153886349, -3292097031055099083, -3623876905370524435, -6584166284538956283, 7321708219616248107, 1312221327481653309, -1869072827747684683, 9041797631320827693, 351209945433278829, -3752656699039072283, -5285381139059220987, 2412762619331892037, -4486158089487320091},
    {2338367021366859525, -3732879055328437843, 5182698232590293885, 8477395247589390197, -908052451448781171, 3390280170817594189, 5385697268268716245, -4551298561016726131, 2118704662143504741, 6484896397837285069, 7202995902159702989, -5143992375538748931, -1022116288654246291, 6502242759150998029, 7048300437528885877, -644167515953195859},
    {4913943146183978541, 1201096409255329493, 4185298871041641109, 7420342779708775677, 39910504476489365, 3679203540574030525, 3651729311059710741, -7196003526766148659, -6942272608173061027, 7291373727841829317, -4131881843873212347, -5296473931174581363, 7561572238337125549, 6358954441664353629, 2276198372634597741, 4479042497052222949},
    {-8215479692751831115, -8159710392801814803, -5902812986806931667, 7181459123792043797, -6585951816803396667, -1766791965645420603, 8029312078883442181, 934487785856021773, -3048626296970047779, -8847216727732705603, -2413922201806678059, -6277659109319295405, 820777438606279405, 1931931294200567917, -8640202853249543123, 2198294708820449493},
    {-2061170304418253395, 4435536143825975053, 2116743861851388949, -3382943965340688619, 8063795042154003925, -2094048463518173115, -8812121454100650019, -542321782502192059, 2305915922017159173, 3624669206392657629, -8147422221931666179, -1471416165907788371, 8880931826641711613, -6786545223839669405, 5596509842617730797, 5352530475119742501},
    {589536527690079429, -1649870331539149131, 2252270660437205885, 6218555544366979469, 1045030854442630069, -2035663276774714859, 5914993284552994229, 5964038489073333629, 9053780152646337869, 8229986054722622037, 6535115022706984515, 8231950245866055773, 4875592534770640293, -2535632177359544835, 2110598410877616965, -6792710657398408635},
    {2590979249081262485, 7067495793551670973, 6442552009712626901, 6278058790509223917, 8885855941077790669, -7810357992485768755, 8223100212667665029, -4587372511518007731, 2223458065936874733, -8317061408753026611, 7014653389157108869, -6659861267228247963, -6724048245404378427, 6085438574898391845, 8047460702851831821, -2491785497018614547},
    {7907100607289061461, -5967356498619390443, 4474889547864818965, 1570373351332613645, -789985845291994723, 4307722769693648765, -1855093252836611371, -1932887108347178595, -2873561444431503499, -1376182468549075315, 3836562045188660277, 1136369267567933301, 4596999140091829085, -3879711110952062027, -4646354482333131123, -80066487645403723},
    {5055214367263627765, -8347158846533947403, -3286516073755799059, 8291384447460406757, 3733732038106481941, 1369333598424031117, -7088663573206402259, -8645011236559610519, -7516413089416164635, -2219683999614955579, 4932370374777565669, 7332597099792767509, -8150557656770313635, -2592712243207258139, -2689279749647428435, 5730260784899533989},
    {-7854893987738148611, 1500112028295497061, -7355043220968948307, 1748070999512274493, -7433090759177392979, -2569068234544172195, -1283454238371137723, 4188215321430572237, -7878400783467448867, 3814983098512545917, 5918176937184638909, -266756568502869043, 4964561849950714357, 5643835505761970989, -4311013088346474787, 7336272318009151301},
    {-2647921199478258075, -3643064198388229931, 6836086067297167949, -710716171619127787, 2811205346697422629, 7471826537583733293, -73522149257279139, 8223733723576808541, 2915606816110400709, 7763565816762746101, 3265948476121173893, -1287393182752987955, 1286157770114460845, -8744484133999740845, -6772082454449729723, -1657147572630728275},
    {-9024263876494234307, -4739244387583312579, 1011178963671370181, 9161580932996250653, 5909194525981743357, 2020980493910427005, -2705444644485177639, 7583499599709211573, 8462790035910388941, -3101261981408246683, -2536485187260616635, -3312923997060334411, -6986914270620755195, -1182649917500532923, 5460710232419649139, 8390451632768854781},
    {8422574767872313477, 6958124595614052909, 460011167049701141, 5301191693956093933, 959575339594310397, -1987407829434321355, 7335571253860602125, 788692197065241437, -5268206636232714763, 1625618185697325573, -6527868277243092427, -9169584263925638123, -5654778062754600811, 359921787786593341, 5697121687420364477, 4591057232817708549},
    {-2036810374344545339, -5769253008476236635, -5952311820433525363, 4717014147022760693, 1751073270853002133, -5913698964386269931, -8618362156149782347, 686366316859030589, -6809260928346093947, 1196786411046534089, -225855598870002635, 3422130828973904949, -2555723553977665643, 7671439278536801501, -9050707179975471523, 2915997592229514797},
    {4753458553884662493, 1340257896450324125, -2865864326898064675, 4431877329462942237, 2218454304646056381, 4362620306624734653, 5873688508388782349, 5865692004491982861, 1699829215805362329, 7596002759754256037, -7025637078085499451, -717520582398265707, -8960006245312629611, -7839877374341002955, 8331503465260004757, 5051595144737648309},
    {-524686475091306859, -2393959885560147115, 4584711589860113499, 568108659884112709, -7835679185793084275, -2732823444826646891, -5160497733151687083, 6947068382240189485, 6053384301167832811, 3817897800007928429, 5343652273051801701, -6009741606261509635, -5014379046426562187, -8312360161333872875, -3872621664749692411, 2283118787421802333},
    {-750322386298855403, 2177894811085134189, -3082284676564850427, 8882524578178153997, 7162097651043367101, 8848520885546969341, -9112580342009147765, -5871383920234448539, -5399132326795086755, 4893775836792495405, 6318941376772743237, 460979237025398733, 9073740920952396885, 4286201042900344621, -5583559799528200171, -1571086385167383499},
    {6337120839819504917, 7619588053454818747, 6508168134418583589, -8974257335359643831, -5025329038097870275, 3865602745890531091, 1051645343137577525, -7881833276543185547, 5007957065951868293, 8549035868063083557, 4298537691346451717, -645873849181996363, 1548770101035897485, -7522815791979145621, 363660485040372757, 8886686515591261669},
    {1741117940299620933, -3517427508070020187, 6432468974224063449, -3616621643015768779, -4386378182915778963, -14792427975615987, -8931693704407584531, 2126866165360859813, 9137543206406305365, 2149352521609639749, -4012730028576135003, -6720454395958954059, 2180464900596573273, 7086942107850263333, -4756234726230295427, -2298980144426751947},
    {-4235470805543499467, 9028981826769543133, -5802917233784034155, 7178423279928793117, 3693317854602630997, 112676919417468141, 5198355694239553733, -9079987366730869219, 2266533106847682389, -4717097136791400267, -258305794865550139, 3972289281694432437, -2956497780624659323, -1229396263772775395, -8745926145043928571, -7498287651296945875},
    {-239213687011468435, 7867061706248670949, 6032623116614745797, -1230595837568683115, 7929136377835213781, -3534564907211993443, -120686304349708389, -8954559571968400107, -2532606544676416099, 7865193471318152461, -6882976314551938827, -761275065710191755, -1762550051954909523, 2153522923608088709, -1985812901769579091, -2925280493707018787},
    {-53362191825037435, -3494677170046278995, 2528980911918169901, 8027228455284602901, 1417784319200198053, -457785040100560595, -3865015729742921347, 2710866665417707589, -3605394805564881939, -7690283485084027923, 7733212466760533693, -5213138296680293523, -6737487839978363507, -3248017271956923155, -8385927196475884091, 1309442288910357829},
    {-4445938562870532251, -8817427919772702499, -7518355535938036731, -1207196552624185795, 2618036374155004741, 2733065855989735933, 5278634713625917365, 8971380895535210045, 2472359751211918813, 2779097939340664597, -7030687043722457331, 5222791218735096221, -6731598385338936371, -6585865321847024715, 6968931239514070109, -8225357584019244523},
    {5114890353744395749, 453844738033774797, -2382843020857327995, 835881713284592381, -6877158457845050059, 132688008214311949, -1160247469620081851, 2073961907817674077, 1751474866815821325, 3723367823761409509, 6787924992589183469, -5371604186670114627, -2834614986695040755, -4059434206782037963, -250460869129114539, 718906968576487177},
    {917063789306671429, -1673557057109347995, -5782514991277678397, -2912268758993218483, 4547666443331355021, 6943808201389765077, 6361278586699960853, 7478643976416802661, -8313614819856017603, -4084492593252907747, -1121937339454160627, 6861192173439717147, 284422191313190637, -8546774213312352931, -6579169824918096115, -6325780137744880023},
    {1363881457624734805, -2730750057542816163, 5749307723292343365, -6295105033018877771, -6056352084130381467, -5061853189072577067, 1313843481952299197, -3108881686621549811, -146257983114224087, -5470778790460504987, -7167086900994590395, 2311289659886650909, -7069087312530512349, 5380277583576410429, -4566205821338358963, 756949003068487509},
    {-8126290004395446483, -8696872502242792459, 1392008194081820557, 2260554288293479381, 6376367438081908629, -8424754187260065979, 9197811608664085005, 393587406567885605, 2783922726129359413, 7179074725634835901, -2874706968993265699, -8945967698892841251, -6362026940752619991, 1788537709974873869, -3828270578959365915, 1642416503508922773},
    {7790938406157485499, -1041679128259842403, -2068024727319744941, -4048362723897599285, -3691987132970053115, -8002139583584877747, 378851498335350981, -6207730946086863755, -1777997295374961739, -8892124398726494379, -2455980297919962731, 454470459099054315, 5316474143052049349, 7643775548402750405, -4195741551606017907, 1168916931068424293},
    {286251886912551333, 1817601886549098821, 3350021541437162949, 5306567651879506397, -8573971641128159899, 2325023254253444253, -7141160679733142531, -5723386044058161539, -390767791553300195, 6671018142003570613, 1227065576509619109, -7039266851559563731, -135241964289274763, -3976789384183709275, 187681664154581437, -8768943526145429963},
    {2698286427311148349, -639388757748354845, 8978742510599540501, 7038564658472064189, -4672175544631165531, -1943402250580336291, 8937784384182815577, -4447685182249295667, 4299473491227072461, -6041669811509503125, 8839637083649105437, 2658517734532966469, -7324229985494127595, -4937775513674211907, 3330197445755658933, 6689684973835653189},
    {7087372023936536989, 6064718019966693549, -68910328266309307, 2914641946940031085, -8130838653812275547, -2846791298504876235, -2812904378351086243, 9022306965558954789, -6150850114179419147, 3897776438787002381, 8507402766559907421, -7428501374349625715, -595257711429269083, -564780210118471011, 2962275796287904429, 8740195056293355453},
    {8982878241776443565, -8310634212077948435, -7854627310418569357, -2308231206476110787, 8118930413299841109, 7898074063288931725, 5784070806556320277, 6753793382999162429, -5422306722039621499, 213845135962793245, 8153171949948296429, -6962130271923217059, -3348145019726662979, -42821890237473123, 5545320471711492777, 4315518587931407325},
    {7174303718022977949, -8976101537702397651, 3692771131489246901, -4803281120884859043, -1930530029382790371, -2217688503221749683, -2961478873420544867, 9178737259685017197, -8071740947441083451, -4461168347536017267, -2244123390674871387, 2241027371830938781, 4500625954893525077, -7926784631128805803, 8756082708945955653, 3106388308503826965},
    {-6599822774991257211, -3886129625522867251, 1996421195888068797, -7702204538760801027, 6365910375159530277, 8461928360659245757, 142622060945535389, -256868587298361767, -3311809918666734827, 1235925390194391061, 1611340722709160653, 5265168291399233453, -7132050215535970603, 7296191071679363781, 5706970190274479189, 1659012737335277869},
    {1156713121193611675, -3812550284080081827, -9025429836430522843, 9031514725833097405, -8447893752073141555, 6811185614959809259, -5647870975879447819, -5480303175580349643, -6940363916597137987, 3928618930267523477, -4789674014706895787, 4730441804464287357, 9163676335165867165, 5277822725858717973, -3857814155725038059, 2856550426686884789},
    {1073983287728580245, 5134297591206936989, 302232597009364877, -7881852145345166555, -4118798451174230115, -2309193318013026643, -6528365721677957795, 6417177295666902597, 4325034143528321877, 4229063019902703707, 8680272634090364877, 2988425570958901005, 6553336159959559907, 1959953227828204037, -6432643970383577491, -916809665672073275},
    {3641545029224020757, 7362089962492654133, -7123275940821446691, 1910009521944679965, -6328887434523941275, 1907456363375970917, -1595424552666087931, 8607530406410481541, -7778436218457172123, -3329511347777540531, -3271233546492705867, 8569829664678476085, 5834229800246917285, -4495769195292186435, 100851470993863939, 6297009569373876349},
    {-399150306989785075, 5093272022965552069, -3558337092244908043, -1706244818353984571, 4844071492570646989, -6129824199634737581, -5448904967489695251, -6382262151962157095, 3615550574999688949, 8673810854965685909, -5379301610298262739, 3373544633414676813, -7241002472248622163, -182416041860269827, -3399566241836454733, 7027873340781621061},
    {9071255700109238197, -5685798705004668291, 584018053385659989, -2651201796556575395, -7059558504187442323, 2376880018283087797, -6696957390532027011, 4049054238107428901, 3751037145403985109, 6048572414280511477, 5277194737434155077, 4189652104036459629, 4370751064342164181, 6323392176937164373, 7334282145046185837, -5455462604246322987},
    {1093915654349820773, 8532680479717962077, 7651051216948026187, -8056092617666901987, -5923940429116284333, 8304934750772134509, 7232874878743553613, -3532181283572138387, -3381292082899942035, 1770502543594013197, -8756175085391201933, -807018243900069891, 3440460999388835027, 3169637733022340405, -5677395729796914139, 7297064253623380245},
    {-6598116491638529323, -6331354969807246807, 4552624799885205205, -7940045100557376011, -7737483399991943717, -5278382925723033899, -4330729765903441019, -1873575616020167075, 2082624252077816197, -4558140387112968027, -5651985503510229411, -4216168210742113491, 2472235755425123605, 6025625211260953893, -8626631971377414715, 2016339039462033725},
    {4372403923097757117, -7141015288390762995, -7505914759572193027, -2733102631854143259, 4925210368345655805, 725503610213716589, 195808994644223853, 5208841826795058437, 6079997925258336445, 5326317293141949749, 452103058735861677, -7269510549184042611, 5352997620138830533, 4804799728303238563, -959696901643144043, 4930890242909309181},
    {794158045245285349, 6879905788820356837, -596764942764836411, -838529988679635731, 2407091905017130285, -3038984787882069803, -1142561116299537091, 178364804725183817, -6213175497813502277, -604507320664297365, -2886213395903915827, -900902660985702627, -1957934745006682963, -4252122717878488123, 4898445892367882213, 804159019855685021},
    {-5154425909621568579, -880223816834033435, -3625584315256677595, -6865005845112215675, -262156425754839691, -7648492448051621171, -3874989325109139259, 5373918791462948709, 6415174981658798869, 7446755597973871413, -7740025964248718003, -3297014732212501683, 4947842408164521797, 6642194873525527277, -7709469242394212523, 5527480958643207373},
    {796103285007511195, 7628367877669761669, -6573836939102741435, 3143157543815210149, -4259185848682673835, -3585730085411830019, 8575751637048845245, 7688692839005584077, 2678740644595227925, -5823957733285973635, 6597654399766995277, -7449226650772710571, 8430903669781316363, -549932638439119133, -2507858365637453323, -1658676960573938173},
    {-8264198256100166739, -6674835397006117685, -9029837221557979131, 3998294211761123501, 4565719746057782773, -3589464153146487043, 1090886022314827437, 7753535104830476861, -6380475119724259, -3682885173527677451, -722642502405682227, 3833063997588407597, -1794392764956791147, 8958757228603890237, -5143167038804118299, -900336222231760755},
    {6617198490871425141, -3067211504848155827, 4461799636151513805, -7398922406303279683, 5034222289532611061, 5219788748558346805, 6405732766818924245, 492309201676797837, 2325194069978869269, 5644543491249969213, -3716405766788463623, -5246907137233923571, -1774663345793152251, -3868848602310058615, -5688854828313474507, -269791176481811363},
    {8805739636391696565, -5455840847687516059, -709543694636777595, 4954559966499789885, -846676029808331083, -2781036376077427317, -6382320249512733971, 2987986860769580893, -5107121068406947211, -2766676533306140147, 5909963407409406069, 3567363264780962955, -7282069978533933907, -4135581650570373675, 2689872170873835069, 4620904317129052077},
    {-8470832033853575755, 2665920436000097157, -3738091296397915371, 1038372965158843861, 5921655221158895043, 7234613426549234653, -2184740762976938525, 1846537526020753005, -5976977361652556835, -3430635608962508299, 7603237700026208995, -2585825876817926229, 6963688376195571957, 2873559091956018773, -8107363815008324371, -431617411567820899},
    {-7069908518226641971, 5205831504219338091, -9051113670405830477, 4274345398427435861, -742884150366949195, 4081698031084855181, -8662693560883058397, -5702726968648901411, -9093640394423656835, 5270600779201118539, 4120324699012816009, 3307856249955461221, 5144989645409167597, -2948702543890229427, -5713288994581680083, -7384414476515240499}
};


pcg initialize_pcg(u_int64_t state0){
    // Randomize states with different LCG than those used in this RNG.
    #ifdef _OPENMP
    int threadid = omp_get_thread_num();
    #else
    int threadid = 0;
    #endif

    for (int i = 0; i < threadid; i++){
        for (int j = 0; j < 16; j++){
            state0 = 0x98fe07ba4ecb6e55 * state0  + 33;
        }
    }
    u_int64_t state1  = 0x98fe07ba4ecb6e55 * state0  + 33;
    u_int64_t state2  = 0x98fe07ba4ecb6e55 * state1  + 33;
    u_int64_t state3  = 0x98fe07ba4ecb6e55 * state2  + 33;
    u_int64_t state4  = 0x98fe07ba4ecb6e55 * state3  + 33;
    u_int64_t state5  = 0x98fe07ba4ecb6e55 * state4  + 33;
    u_int64_t state6  = 0x98fe07ba4ecb6e55 * state5  + 33;
    u_int64_t state7  = 0x98fe07ba4ecb6e55 * state6  + 33;
    u_int64_t state8  = 0x98fe07ba4ecb6e55 * state7  + 33;
    u_int64_t state9  = 0x98fe07ba4ecb6e55 * state8  + 33;
    u_int64_t state10 = 0x98fe07ba4ecb6e55 * state9  + 33;
    u_int64_t state11 = 0x98fe07ba4ecb6e55 * state10 + 33;
    u_int64_t state12 = 0x98fe07ba4ecb6e55 * state11 + 33;
    u_int64_t state13 = 0x98fe07ba4ecb6e55 * state12 + 33;
    u_int64_t state14 = 0x98fe07ba4ecb6e55 * state13 + 33;
    u_int64_t state15 = 0x98fe07ba4ecb6e55 * state14 + 33;
    __m512i_2 state = {
        _mm512_set_epi64(state0, state1, state2,  state3,  state4,  state5,  state6,  state7),
        _mm512_set_epi64(state8, state9, state10, state11, state12, state13, state14, state15)
    };
    // __m512i increment[2] = {
    //     _mm512_set_epi64( 1,  3,  5,  7,  9, 11, 13, 15),
    //     _mm512_set_epi64(17, 19, 21, 23, 25, 27, 29, 31)
    // };
    __int64_t mults[16];
    for (int i = 0; i < 16; i++){
         mults[i] = lcg_multipliers_array[threadid][i];
    }
    const __m512i_2 lcg_multiplier = {
        _mm512_set_epi64(mults[0], mults[1],  mults[2],  mults[3],  mults[4],  mults[5],  mults[6],  mults[7]),
        _mm512_set_epi64(mults[8], mults[9], mults[10], mults[11], mults[12], mults[13], mults[14], mults[15])
    };
    __m512i increment = _mm512_set1_epi64(1);
    // __m512i lcg_multiplier = {
    //     _mm512_set1_epi64(6364136223846793005),
    //     _mm512_set1_epi64(-2278456823497801899)
    // };
    __m512i transformation_multiplier = _mm512_set1_epi64(-5840758589994634535);

    return { state, lcg_multiplier, increment, transformation_multiplier };
}



inline float srandunif(){
    return GLOBAL_ZIGG.unif();
}
inline float srandnormal(){
    return GLOBAL_ZIGG.norm();
}
void svrandnormal(float* x, std::size_t N){
    for (std::size_t n = 0; n < N; n++){
        x[n] = GLOBAL_ZIGG.norm();
    }
    return;
}

float sgamma(float alpha){
    float d = alpha - (1.0f/3.0f);
    float c = 1 / sqrtf(9.0f*d);
    float x, v, v3, g;
    do {
        do {
            x = srandnormal();
            v = 1.0f + c * x;
        } while (v < 0.0f);
        v3 = v * v * v;
        g = d * v3;
    } while (logf(srandunif()) > 0.5f * x * x + d - g + d * logf(v3));
    return g;
}

inline __m512 srandunif_vector(){
    return vrandunif(&GLOBAL_PCG);
}

inline __m512_2 srandunif_2vectors(){
    return vrandunif_2(&GLOBAL_PCG);
}

template<std::size_t NUMGROUPS>
void update_probabilities(float* probabilities, InverseWisharts<NUMGROUPS>& iw){
    float probs[NUMGROUPS];
    float prob_sum = 0.0f;
    for (std::size_t g = 0; g < NUMGROUPS; g++){
        prob_sum += probs[g] = sgamma(iw[g][7]);
    }
    float inv_prob_sum = 1.0f / prob_sum;
    for (std::size_t g = 0; g < NUMGROUPS; g++){
        probabilities[g] = probs[g] * inv_prob_sum;
    }
}

// @inline function update_probabilities!(rng::AbstractRNG, probabilities, α)
//     probs = randdirichlet(rng, α)
//     @inbounds for i ∈ eachindex(probs)
//         probabilities[i] = probs[i]
//     end
// end
// @inline update_probabilities!(probabilities, α) = update_probabilities!(Random.GLOBAL_RNG, probabilities, α)


